<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Server Inspector - MexKYC</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        header {
            background: #2c3e50;
            color: white;
            padding: 20px 30px;
            border-bottom: 3px solid #34495e;
        }
        
        header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        header p {
            font-size: 14px;
            color: #ecf0f1;
        }
        
        .status-bar {
            background: #ecf0f1;
            padding: 10px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #e74c3c;
        }
        
        .status-dot.connected {
            background: #27ae60;
        }
        
        .config {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }
        
        .config-row {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }
        
        .config-row:last-child {
            margin-bottom: 0;
        }
        
        .config label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 13px;
            color: #555;
        }
        
        .config input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .config button {
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .config button:hover {
            background: #2980b9;
        }
        
        .tools-section {
            padding: 30px;
        }
        
        .tools-section h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .tool {
            margin-bottom: 30px;
            border: 1px solid #ddd;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .tool-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .tool-header:hover {
            background: #e9ecef;
        }
        
        .tool-header h3 {
            font-size: 16px;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .tool-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .tool-status-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .tool-status-badge.success {
            background: #d4edda;
            color: #155724;
        }
        
        .tool-status-badge.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .tool-status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .tool-header .expand-icon {
            color: #7f8c8d;
            font-size: 18px;
        }
        
        .tool-body {
            display: none;
            padding: 20px;
        }
        
        .tool-body.expanded {
            display: block;
        }
        
        .tool-description {
            color: #555;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
            padding: 12px;
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            border-radius: 4px;
        }
        
        .tool-info {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #7f8c8d;
        }
        
        .tool-info-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .tool-info-item strong {
            color: #2c3e50;
        }
        
        .params {
            margin-bottom: 15px;
        }
        
        .param {
            margin-bottom: 15px;
        }
        
        .param label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 13px;
            color: #2c3e50;
        }
        
        .param label .required {
            color: #e74c3c;
        }
        
        .param input,
        .param select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .param .help-text {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 4px;
        }
        
        .execute-btn {
            padding: 10px 20px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        
        .execute-btn:hover {
            background: #229954;
        }
        
        .execute-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        
        .result {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #3498db;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .result.error {
            border-left-color: #e74c3c;
            background: #fdf2f2;
        }
        
        .result.success {
            border-left-color: #27ae60;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-left: 4px solid #27ae60;
        }
        
        .result h4 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .result-meta {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #ddd;
        }
        
        .result pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .file-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .file-selector select {
            flex: 1;
        }
        
        .file-selector button {
            padding: 8px 16px;
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .file-selector button:hover {
            background: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>MCP Server Inspector</h1>
            <p>MexKYC MCP Server v1.0.0 | Model Context Protocol</p>
        </header>
        
        <div class="status-bar">
            <div class="status-indicator">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Disconnected</span>
            </div>
            <button onclick="testConnection()">Test Connection</button>
        </div>
        
        <div class="config">
            <div class="config-row">
                <div style="flex: 1;">
                    <label>Server URL</label>
                    <input type="text" id="serverUrl" value="http://localhost:3000" placeholder="http://localhost:3000" onchange="saveConfig()">
                </div>
                <div style="flex: 1;">
                    <label>API Key</label>
                    <input type="text" id="apiKey" placeholder="Enter API key" onchange="saveConfig()">
                </div>
                <div style="display: flex; align-items: flex-end;">
                    <button onclick="saveConfig()">Save Config</button>
                </div>
            </div>
        </div>
        
        <!-- Quick Batch Import Section -->
        <div class="tools-section" style="background: #e8f5e9; border-bottom: 2px solid #27ae60;">
            <h2 style="color: #27ae60; border-bottom-color: #27ae60;">üöÄ Quick Batch Import</h2>
            <p style="color: #555; margin-bottom: 15px;">Import all documents for a customer in one click, then build & validate.</p>
            
            <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px;">
                <button onclick="quickBatchImport('grupo-pounj')" style="padding: 12px 24px; background: #2c3e50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                    üìÅ Grupo Pounj (6 docs)
                </button>
                <button onclick="quickBatchImport('pfds')" style="padding: 12px 24px; background: #2c3e50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                    üìÅ PFDS (6 docs)
                </button>
                <button onclick="quickBatchImport('enrique-cello')" style="padding: 12px 24px; background: #2c3e50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                    üìÅ Enrique Cello (4 docs)
                </button>
            </div>
            
            <!-- Supported Documents Preview (Collapsible) -->
            <div style="background: white; border-radius: 6px; border: 1px solid #ddd; margin-bottom: 15px;">
                <div onclick="toggleSupportedDocs()" style="padding: 12px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; border-radius: 6px 6px 0 0;">
                    <span style="font-weight: 600; color: #2c3e50;">üìë View Supported Document Types</span>
                    <span id="supportedDocsToggle" style="color: #7f8c8d;">‚ñº Show</span>
                </div>
                <div id="supportedDocsPreview" style="display: none; padding: 15px;">
                    <!-- Will be populated by JS -->
                </div>
            </div>
            
            <div id="quickImportStatus" style="display: none; padding: 15px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                <div id="quickImportProgress"></div>
            </div>
            
            <!-- Workflow Guide -->
            <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #ddd; margin-top: 15px;">
                <div style="font-weight: 600; margin-bottom: 10px; color: #2c3e50;">üìã Workflow Order:</div>
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <span style="background: #3498db; color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px;">1. Batch Import</span>
                    <span style="color: #999;">‚Üí</span>
                    <span style="background: #9b59b6; color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px;">2. Build Profile</span>
                    <span style="color: #999;">‚Üí</span>
                    <span style="background: #e67e22; color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px;">3. Validate</span>
                    <span style="color: #999;">‚Üí</span>
                    <span style="background: #27ae60; color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px;">4. Get Report</span>
                </div>
            </div>
        </div>
        
        <div class="tools-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Available Tools</h2>
                <span id="toolsCount" style="color: #7f8c8d; font-size: 14px;">Loading...</span>
            </div>
            <div id="toolsContainer">
                <!-- Tools will be populated here -->
            </div>
        </div>
    </div>
    
    <script>
        const SERVER_URL_KEY = 'mcp_inspector_server_url';
        const API_KEY_KEY = 'mcp_inspector_api_key';
        const CURRENT_CUSTOMER_KEY = 'mcp_inspector_current_customer';
        
        let tools = [];
        let availableFiles = {};
        let currentCustomerId = localStorage.getItem(CURRENT_CUSTOMER_KEY) || '';
        
        // All supported document types for KYC
        const ALL_SUPPORTED_DOC_TYPES = [
            { code: 'acta', name: 'Acta Constitutiva', icon: 'üè¢', description: 'Company incorporation document' },
            { code: 'sat_constancia', name: 'SAT Constancia', icon: 'üìã', description: 'Tax registration certificate' },
            { code: 'fm2', name: 'FM2/Immigration', icon: 'üõÇ', description: 'Immigration document for foreigners' },
            { code: 'ine', name: 'INE', icon: 'ü™™', description: 'Mexican national ID card' },
            { code: 'passport', name: 'Passport', icon: 'üìò', description: 'International passport' },
            { code: 'cfe', name: 'CFE Receipt', icon: '‚ö°', description: 'Electricity bill (proof of address)' },
            { code: 'telmex', name: 'Telmex Receipt', icon: 'üìû', description: 'Phone bill (proof of address)' },
            { code: 'bank_statement', name: 'Bank Statement', icon: 'üè¶', description: 'Full bank statement with transactions' },
            { code: 'bank_identity_page', name: 'Bank Identity Page', icon: 'üí≥', description: 'First page of bank statement (identity)' }
        ];
        
        // Generate document checklist HTML
        function renderDocumentChecklist(importedDocTypes = []) {
            const imported = new Set(importedDocTypes);
            return `
                <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-top: 15px;">
                    <div style="font-weight: 600; color: #2c3e50; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                        <span>üìë Supported Document Types</span>
                        <span style="font-size: 12px; color: #7f8c8d;">${imported.size} of ${ALL_SUPPORTED_DOC_TYPES.length} imported</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px;">
                        ${ALL_SUPPORTED_DOC_TYPES.map(doc => {
                            const isImported = imported.has(doc.code);
                            return `
                                <div style="display: flex; align-items: center; padding: 8px 12px; border-radius: 6px; 
                                    background: ${isImported ? '#d4edda' : 'white'}; 
                                    border: 1px solid ${isImported ? '#27ae60' : '#ddd'};
                                    ${isImported ? 'box-shadow: 0 1px 3px rgba(39,174,96,0.2);' : ''}">
                                    <span style="font-size: 18px; margin-right: 8px;">${isImported ? '‚úÖ' : '‚¨ú'}</span>
                                    <div>
                                        <div style="font-weight: 500; font-size: 13px; color: ${isImported ? '#155724' : '#666'};">
                                            ${doc.icon} ${doc.name}
                                        </div>
                                        <div style="font-size: 11px; color: ${isImported ? '#155724' : '#999'};">
                                            ${doc.description}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }
        
        // Set current customer and auto-populate all customer_id fields
        function setCurrentCustomer(customerId) {
            currentCustomerId = customerId;
            localStorage.setItem(CURRENT_CUSTOMER_KEY, customerId);
            
            // Auto-populate all customer_id input fields (multiple selector patterns)
            const selectors = [
                'input[id*="customer_id"]',
                'input[id$="-customer_id"]',
                'input[placeholder*="customer"]'
            ];
            
            selectors.forEach(selector => {
                document.querySelectorAll(selector).forEach(input => {
                    if (input.id.includes('customer_id') || input.placeholder.toLowerCase().includes('customer')) {
                        input.value = customerId;
                        input.style.background = '#e8f5e9';  // Highlight auto-filled
                        input.style.borderColor = '#27ae60';
                    }
                });
            });
            
            // Also update by iterating through all tools
            tools.forEach(tool => {
                const input = document.getElementById(`param-${tool.name}-customer_id`);
                if (input) {
                    input.value = customerId;
                    input.style.background = '#e8f5e9';
                    input.style.borderColor = '#27ae60';
                }
            });
            
            // Update the current customer display
            updateCurrentCustomerDisplay();
            
            console.log(`‚úÖ Set current customer: ${customerId}, updated ${document.querySelectorAll('input[id*="customer_id"]').length} fields`);
        }
        
        // Show current customer prominently
        function updateCurrentCustomerDisplay() {
            let display = document.getElementById('currentCustomerDisplay');
            if (!display) {
                display = document.createElement('div');
                display.id = 'currentCustomerDisplay';
                display.style.cssText = 'background: #3498db; color: white; padding: 8px 15px; border-radius: 4px; font-weight: 600; display: inline-block;';
                const statusBar = document.querySelector('.status-bar');
                if (statusBar) {
                    statusBar.appendChild(display);
                }
            }
            if (currentCustomerId) {
                display.innerHTML = `üìã Current: <span style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 3px;">${currentCustomerId}</span>`;
                display.style.display = 'inline-block';
            } else {
                display.style.display = 'none';
            }
        }
        
        // Load saved config
        function loadConfig() {
            const savedUrl = localStorage.getItem(SERVER_URL_KEY);
            const savedKey = localStorage.getItem(API_KEY_KEY);
            if (savedUrl) document.getElementById('serverUrl').value = savedUrl;
            if (savedKey) document.getElementById('apiKey').value = savedKey;
        }
        
        // Save config
        function saveConfig() {
            const url = document.getElementById('serverUrl').value;
            const key = document.getElementById('apiKey').value;
            localStorage.setItem(SERVER_URL_KEY, url);
            localStorage.setItem(API_KEY_KEY, key);
            // Auto-reload tools if connected
            if (document.getElementById('statusDot').classList.contains('connected')) {
                loadTools();
            }
        }
        
        // Get server URL and API key
        function getServerUrl() {
            return document.getElementById('serverUrl').value || 'http://localhost:3000';
        }
        
        function getApiKey() {
            return document.getElementById('apiKey').value || '';
        }
        
        // Customer document presets
        const CUSTOMER_DOCS = {
            'grupo-pounj': [
                { doc_type: 'acta', file_url: 'file:///Users/ashishpunj/Desktop/mcp-docs/grupo-pounj/Acta_Constitutiva_grupo-pounj.pdf' },
                { doc_type: 'sat_constancia', file_url: 'file:///Users/ashishpunj/Desktop/mcp-docs/grupo-pounj/SAT_Constancia_grupo-pounj.pdf' },
                { doc_type: 'fm2', file_url: 'file:///Users/ashishpunj/Desktop/mcp-docs/grupo-pounj/FM2_grupo-pounj.pdf' },
                { doc_type: 'passport', file_url: 'file:///Users/ashishpunj/Desktop/mcp-docs/grupo-pounj/Passport_Front_Ashish_Punj_grupo-pounj.jpeg' },
                { doc_type: 'cfe', file_url: 'file:///Users/ashishpunj/Desktop/mcp-docs/grupo-pounj/CFE_Recibo_grupo-pounj_Octubre_2025.pdf' },
                { doc_type: 'bank_identity_page', file_url: 'file:///Users/ashishpunj/Desktop/mcp-docs/grupo-pounj/Bank_Estado_Cuenta_grupo-pounj_Octubre_2025.pdf' }
            ],
            'pfds': [
                { doc_type: 'acta', file_url: 'file:///Users/ashishpunj/Desktop/mcp-docs/pfds/Acta_Constitutiva_pfds.pdf' },
                { doc_type: 'sat_constancia', file_url: 'file:///Users/ashishpunj/Desktop/mcp-docs/pfds/SAT_Constancia_pfds.pdf' },
                { doc_type: 'fm2', file_url: 'file:///Users/ashishpunj/Desktop/mcp-docs/pfds/FM2_pfds.pdf' },
                { doc_type: 'passport', file_url: 'file:///Users/ashishpunj/Desktop/mcp-docs/pfds/Passport_Front_Ashish_Punj_pfds.jpeg' },
                { doc_type: 'telmex', file_url: 'file:///Users/ashishpunj/Desktop/mcp-docs/pfds/Telmex_Recibo_pfds_Octubre_2025.pdf' },
                { doc_type: 'bank_identity_page', file_url: 'file:///Users/ashishpunj/Desktop/mcp-docs/pfds/Bank_Estado_Cuenta_pfds_Octubre_2025.pdf' }
            ],
            'enrique-cello': [
                { doc_type: 'sat_constancia', file_url: 'file:///Users/ashishpunj/Desktop/mcp-docs/enrique-cello/SAT_Constancia_enrique-cello.pdf' },
                { doc_type: 'ine', file_url: 'file:///Users/ashishpunj/Desktop/mcp-docs/enrique-cello/INE_enrique-cello.pdf' },
                { doc_type: 'cfe', file_url: 'file:///Users/ashishpunj/Desktop/mcp-docs/enrique-cello/CFE_Recibo_enrique-cello_Octubre_2025.pdf' },
                { doc_type: 'bank_identity_page', file_url: 'file:///Users/ashishpunj/Desktop/mcp-docs/enrique-cello/Bank_Estado_Cuenta_enrique-cello_Octubre_2025.pdf' }
            ]
        };
        
        // Quick batch import with one click
        async function quickBatchImport(customerId) {
            const statusDiv = document.getElementById('quickImportStatus');
            const progressDiv = document.getElementById('quickImportProgress');
            const docs = CUSTOMER_DOCS[customerId];
            
            if (!docs) {
                alert('Unknown customer: ' + customerId);
                return;
            }
            
            statusDiv.style.display = 'block';
            
            // Show which documents are being imported
            const docTypesBeingImported = docs.map(d => d.doc_type);
            progressDiv.innerHTML = `
                <div style="font-weight: 600; color: #2c3e50;">‚è≥ Importing ${docs.length} documents for ${customerId}...</div>
                <div style="margin-top: 10px; color: #7f8c8d;">This may take 1-2 minutes. AI is extracting data from each document.</div>
                
                <!-- Show documents being processed -->
                <div style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 8px;">
                    ${docs.map(d => {
                        const docInfo = ALL_SUPPORTED_DOC_TYPES.find(t => t.code === d.doc_type) || { icon: 'üìÑ', name: d.doc_type };
                        return `<span style="background: #fff3cd; border: 1px solid #ffc107; padding: 4px 10px; border-radius: 20px; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                            <span class="loading" style="width: 12px; height: 12px; border-width: 2px;"></span>
                            ${docInfo.icon} ${docInfo.name}
                        </span>`;
                    }).join('')}
                </div>
            `;
            
            try {
                const startTime = Date.now();
                const response = await fetch(`${getServerUrl()}/mcp/tools/batch_import_documents`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': getApiKey()
                    },
                    body: JSON.stringify({
                        customer_id: customerId,
                        documents: docs
                    })
                });
                
                const data = await response.json();
                const duration = ((Date.now() - startTime) / 1000).toFixed(1);
                
                if (data.ok) {
                    const successCount = data.data.success_count;
                    const failedCount = data.data.failed_count;
                    const importedDocs = data.data.results || [];
                    
                    // Extract successfully imported doc types
                    const importedDocTypes = importedDocs
                        .filter(r => r.status === 'success')
                        .map(r => r.doc_type);
                    
                    // Set current customer and auto-populate all fields
                    setCurrentCustomer(customerId);
                    
                    progressDiv.innerHTML = `
                        <div style="font-weight: 600; color: #27ae60; font-size: 16px;">‚úÖ Import Complete for ${customerId.toUpperCase()}</div>
                        <div style="margin-top: 10px;">
                            <span style="background: #d4edda; padding: 4px 8px; border-radius: 4px; margin-right: 10px;">‚úì ${successCount} succeeded</span>
                            ${failedCount > 0 ? `<span style="background: #f8d7da; padding: 4px 8px; border-radius: 4px;">‚úó ${failedCount} failed</span>` : ''}
                            <span style="color: #7f8c8d; margin-left: 10px;">‚è±Ô∏è ${duration}s</span>
                        </div>
                        
                        <!-- Document Checklist showing what was imported -->
                        ${renderDocumentChecklist(importedDocTypes)}
                        
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                            <div style="font-weight: 600; margin-bottom: 10px;">üéØ Next Steps (customer_id auto-populated):</div>
                            <button onclick="runBuildProfile('${customerId}')" style="padding: 8px 16px; background: #9b59b6; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                                2. Build Profile
                            </button>
                            <button onclick="runValidateProfile('${customerId}')" style="padding: 8px 16px; background: #e67e22; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                                3. Validate
                            </button>
                            <button onclick="runGetReport('${customerId}')" style="padding: 8px 16px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                4. Get Report
                            </button>
                        </div>
                    `;
                } else {
                    progressDiv.innerHTML = `<div style="color: #e74c3c;">‚ùå Error: ${data.message || 'Import failed'}</div>`;
                }
            } catch (error) {
                progressDiv.innerHTML = `<div style="color: #e74c3c;">‚ùå Network Error: ${error.message}</div>`;
            }
        }
        
        // Quick action buttons for next steps
        async function runBuildProfile(customerId) {
            const progressDiv = document.getElementById('quickImportProgress');
            progressDiv.innerHTML += `<div style="margin-top: 10px; color: #9b59b6;">‚è≥ Building profile...</div>`;
            
            try {
                const response = await fetch(`${getServerUrl()}/mcp/tools/build_kyc_profile`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-API-Key': getApiKey() },
                    body: JSON.stringify({ customer_id: customerId })
                });
                const data = await response.json();
                if (data.ok) {
                    const company = data.data.companyIdentity?.razon_social || data.data.companyTaxProfile?.razon_social || customerId;
                    progressDiv.innerHTML += `<div style="color: #27ae60;">‚úÖ Profile built for: ${company}</div>`;
                } else {
                    progressDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Build failed: ${data.message}</div>`;
                }
            } catch (e) {
                progressDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Error: ${e.message}</div>`;
            }
        }
        
        async function runValidateProfile(customerId) {
            const progressDiv = document.getElementById('quickImportProgress');
            progressDiv.innerHTML += `<div style="margin-top: 10px; color: #e67e22;">‚è≥ Validating profile...</div>`;
            
            try {
                const response = await fetch(`${getServerUrl()}/mcp/tools/validate_kyc_profile`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-API-Key': getApiKey() },
                    body: JSON.stringify({ customer_id: customerId })
                });
                const data = await response.json();
                if (data.ok) {
                    const score = data.data.score_percent;
                    const status = data.data.overall_status;
                    const statusColor = status === 'APPROVED' ? '#27ae60' : status === 'REJECTED' ? '#e74c3c' : '#e67e22';
                    progressDiv.innerHTML += `<div style="color: ${statusColor};">‚úÖ Validation: ${score}% - ${status}</div>`;
                } else {
                    progressDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Validation failed: ${data.message}</div>`;
                }
            } catch (e) {
                progressDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Error: ${e.message}</div>`;
            }
        }
        
        async function runGetReport(customerId) {
            const progressDiv = document.getElementById('quickImportProgress');
            progressDiv.innerHTML += `<div style="margin-top: 10px; color: #27ae60;">‚è≥ Generating report...</div>`;
            
            try {
                const response = await fetch(`${getServerUrl()}/mcp/tools/get_kyc_report`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-API-Key': getApiKey() },
                    body: JSON.stringify({ customer_id: customerId })
                });
                const data = await response.json();
                if (data.ok) {
                    progressDiv.innerHTML += `<div style="color: #27ae60;">‚úÖ Report generated! Scroll down to see details in the tools section.</div>`;
                    // Also show a summary
                    if (data.data.sections) {
                        progressDiv.innerHTML += `<details style="margin-top: 10px;"><summary style="cursor: pointer; font-weight: 600;">üìÑ View Report Summary</summary><pre style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 11px; margin-top: 10px;">${JSON.stringify(data.data, null, 2)}</pre></details>`;
                    }
                } else {
                    progressDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Report failed: ${data.message}</div>`;
                }
            } catch (e) {
                progressDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Error: ${e.message}</div>`;
            }
        }
        
        // Test connection
        async function testConnection() {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            try {
                statusText.textContent = 'Testing...';
                const response = await fetch(`${getServerUrl()}/mcp/tools`, {
                    headers: {
                        'X-API-Key': getApiKey()
                    }
                });
                
                if (response.ok) {
                    statusDot.classList.add('connected');
                    statusText.textContent = 'Connected';
                    await loadTools();
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                statusDot.classList.remove('connected');
                statusText.textContent = `Disconnected: ${error.message}`;
            }
        }
        
        // Load tools
        async function loadTools() {
            try {
                const response = await fetch(`${getServerUrl()}/mcp/tools`, {
                    headers: {
                        'X-API-Key': getApiKey()
                    }
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                tools = data.tools || [];
                document.getElementById('toolsCount').textContent = `${tools.length} ${tools.length === 1 ? 'tool' : 'tools'} available`;
                renderTools();
                
                // Load available files for import_kyc_document
                await loadAvailableFiles();
            } catch (error) {
                console.error('Failed to load tools:', error);
            }
        }
        
        // Load available files
        async function loadAvailableFiles() {
            try {
                const response = await fetch(`${getServerUrl()}/mcp/documents`, {
                    headers: {
                        'X-API-Key': getApiKey()
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // Server returns { documents: { company: [{ name, path, ... }] } }
                    // Convert to format expected by inspector: { company: [{ name, url }] }
                    availableFiles = {};
                    if (data.documents) {
                        Object.keys(data.documents).forEach(company => {
                            availableFiles[company] = data.documents[company]
                                .filter(file => file.suggestedDocType !== 'skip')
                                .map(file => ({
                                    name: file.name,
                                    url: `file://${file.path}`
                                }));
                        });
                    }
                }
            } catch (error) {
                console.error('Failed to load files:', error);
            }
        }
        
        // Track tool execution status
        const toolStatus = {};
        
        // Render tools
        function renderTools() {
            const container = document.getElementById('toolsContainer');
            container.innerHTML = '';
            
            if (tools.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 40px;">No tools available. Check server connection.</p>';
                return;
            }
            
            tools.forEach(tool => {
                const status = toolStatus[tool.name] || { status: 'idle', lastExecuted: null };
                const statusBadge = status.status === 'success' ? 
                    '<span class="tool-status-badge success">‚úì Executed</span>' :
                    status.status === 'error' ?
                    '<span class="tool-status-badge error">‚úó Error</span>' :
                    status.status === 'executing' ?
                    '<span class="tool-status-badge pending">‚è≥ Running...</span>' :
                    '';
                
                const toolDiv = document.createElement('div');
                toolDiv.className = 'tool';
                toolDiv.innerHTML = `
                    <div class="tool-header" onclick="toggleTool('${tool.name}')">
                        <div>
                            <h3>${tool.name}</h3>
                            <div class="tool-status" id="status-${tool.name}">
                                ${statusBadge}
                                ${status.lastExecuted ? `<span>Last: ${new Date(status.lastExecuted).toLocaleTimeString()}</span>` : ''}
                            </div>
                        </div>
                        <span class="expand-icon" id="icon-${tool.name}">‚ñº</span>
                    </div>
                    <div class="tool-body" id="body-${tool.name}">
                        <div class="tool-description">
                            <strong>What it does:</strong> ${tool.description || 'No description available'}
                        </div>
                        <div class="tool-info" id="info-${tool.name}"></div>
                        <div class="params" id="params-${tool.name}"></div>
                        <button class="execute-btn" onclick="executeTool('${tool.name}')" id="btn-${tool.name}">‚ñ∂ Execute Tool</button>
                        <div id="result-${tool.name}"></div>
                    </div>
                `;
                container.appendChild(toolDiv);
                
                // Render parameters and info
                renderToolParams(tool);
                renderToolInfo(tool);
            });
        }
        
        // Render tool info (parameter count, etc.)
        function renderToolInfo(tool) {
            const infoDiv = document.getElementById(`info-${tool.name}`);
            if (!infoDiv) return;
            
            const schema = tool.inputSchema || tool.parameters || {};
            const paramCount = schema.properties ? Object.keys(schema.properties).length : 0;
            const requiredCount = schema.required ? schema.required.length : 0;
            
            infoDiv.innerHTML = `
                <div class="tool-info-item">
                    <strong>Parameters:</strong> ${paramCount} ${paramCount === 1 ? 'parameter' : 'parameters'}
                </div>
                <div class="tool-info-item">
                    <strong>Required:</strong> ${requiredCount} ${requiredCount === 1 ? 'field' : 'fields'}
                </div>
            `;
        }
        
        // Render tool parameters
        function renderToolParams(tool) {
            const paramsDiv = document.getElementById(`params-${tool.name}`);
            // Support both 'parameters' (server format) and 'inputSchema' (MCP standard)
            const schema = tool.inputSchema || tool.parameters || {};
            if (!schema.properties) {
                paramsDiv.innerHTML = '<p style="color: #7f8c8d; font-size: 13px;">This tool has no parameters.</p>';
                return;
            }
            
            const properties = schema.properties;
            const required = schema.required || [];
            
            Object.keys(properties).forEach(paramName => {
                const param = properties[paramName];
                const isRequired = required.includes(paramName);
                const paramDiv = document.createElement('div');
                paramDiv.className = 'param';
                
                let inputHtml = '';
                
                // Special handling for doc_type enum
                if (paramName === 'doc_type' && param.enum) {
                    inputHtml = `<select id="param-${tool.name}-${paramName}">`;
                    param.enum.forEach(val => {
                        inputHtml += `<option value="${val}">${val}</option>`;
                    });
                    inputHtml += '</select>';
                }
                // Special handling for file_url with file selector
                else if (paramName === 'file_url') {
                    inputHtml = `
                        <div class="file-selector">
                            <select id="file-selector-${tool.name}" onchange="selectFile('${tool.name}')">
                                <option value="">-- Select File --</option>
                            </select>
                            <button onclick="browseFiles('${tool.name}')">Browse</button>
                        </div>
                        <input type="text" id="param-${tool.name}-${paramName}" placeholder="${param.description || paramName}">
                    `;
                }
                // Regular input with examples
                else {
                    const inputType = param.type === 'number' ? 'number' : 'text';
                    let placeholder = param.description || paramName;
                    
                    // Add example values for common parameters
                    if (paramName === 'customer_id') {
                        placeholder = 'e.g., pfds, grupo-pounj, enrique-cello';
                    } else if (paramName === 'language') {
                        placeholder = 'e.g., en (English) or es (Spanish)';
                    } else if (paramName === 'include_trace') {
                        placeholder = 'true or false';
                    }
                    
                    inputHtml = `<input type="${inputType}" id="param-${tool.name}-${paramName}" placeholder="${placeholder}">`;
                }
                
                paramDiv.innerHTML = `
                    <label>
                        ${paramName}
                        ${isRequired ? '<span class="required">*</span>' : ''}
                    </label>
                    ${inputHtml}
                    ${param.description ? `<div class="help-text">${param.description}</div>` : ''}
                `;
                
                paramsDiv.appendChild(paramDiv);
                
                // Auto-populate customer_id with current customer
                if (paramName === 'customer_id' && currentCustomerId) {
                    const input = document.getElementById(`param-${tool.name}-${paramName}`);
                    if (input) {
                        input.value = currentCustomerId;
                        input.style.background = '#e8f5e9';  // Highlight auto-filled
                    }
                }
            });
            
            // Populate file selector if this is import_kyc_document
            if (tool.name === 'import_kyc_document') {
                populateFileSelector(tool.name);
            }
        }
        
        // Populate file selector
        function populateFileSelector(toolName) {
            const selector = document.getElementById(`file-selector-${toolName}`);
            if (!selector) return;
            
            selector.innerHTML = '<option value="">-- Select File --</option>';
            
            Object.keys(availableFiles).forEach(company => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = company;
                availableFiles[company].forEach(file => {
                    const option = document.createElement('option');
                    option.value = file.url;
                    option.textContent = file.name;
                    optgroup.appendChild(option);
                });
                selector.appendChild(optgroup);
            });
        }
        
        // Select file
        function selectFile(toolName) {
            const selector = document.getElementById(`file-selector-${toolName}`);
            const input = document.getElementById(`param-${toolName}-file_url`);
            if (selector && input) {
                input.value = selector.value;
            }
        }
        
        // Browse files (reload)
        async function browseFiles(toolName) {
            await loadAvailableFiles();
            populateFileSelector(toolName);
        }
        
        // Toggle tool expansion
        function toggleTool(toolName) {
            const body = document.getElementById(`body-${toolName}`);
            const icon = document.getElementById(`icon-${toolName}`);
            
            if (body.classList.contains('expanded')) {
                body.classList.remove('expanded');
                icon.textContent = '‚ñº';
            } else {
                body.classList.add('expanded');
                icon.textContent = '‚ñ≤';
                
                // Auto-populate customer_id when tool is expanded
                if (currentCustomerId) {
                    const customerInput = document.getElementById(`param-${toolName}-customer_id`);
                    if (customerInput && !customerInput.value) {
                        customerInput.value = currentCustomerId;
                        customerInput.style.background = '#e8f5e9';
                        customerInput.style.borderColor = '#27ae60';
                    }
                }
            }
        }
        
        // Execute tool
        async function executeTool(toolName) {
            const resultDiv = document.getElementById(`result-${toolName}`);
            const executeBtn = document.getElementById(`btn-${toolName}`);
            const statusDiv = document.getElementById(`status-${toolName}`);
            const startTime = Date.now();
            
            // Update status
            toolStatus[toolName] = { status: 'executing', lastExecuted: null };
            if (statusDiv) {
                statusDiv.innerHTML = '<span class="tool-status-badge pending">‚è≥ Running...</span>';
            }
            
            resultDiv.innerHTML = '<div class="result"><h4>‚è≥ Executing tool...</h4><div class="loading"></div><p style="margin-top: 10px; color: #7f8c8d; font-size: 13px;">Processing request...</p></div>';
            executeBtn.disabled = true;
            executeBtn.textContent = '‚è≥ Executing...';
            
            try {
                // Collect parameters
                const params = {};
                const tool = tools.find(t => t.name === toolName);
                
                // Support both 'parameters' (server format) and 'inputSchema' (MCP standard)
                const schema = tool.inputSchema || tool.parameters || {};
                if (schema.properties) {
                    Object.keys(schema.properties).forEach(paramName => {
                        const input = document.getElementById(`param-${toolName}-${paramName}`);
                        if (input && input.value) {
                            const paramType = schema.properties[paramName].type;
                            if (paramType === 'number' || input.type === 'number') {
                                params[paramName] = parseFloat(input.value);
                            } else if (paramType === 'boolean') {
                                params[paramName] = input.value === 'true' || input.checked;
                            } else {
                                params[paramName] = input.value;
                            }
                        }
                    });
                }
                
                // Execute tool - send params directly (not wrapped in 'params')
                const response = await fetch(`${getServerUrl()}/mcp/tools/${toolName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': getApiKey()
                    },
                    body: JSON.stringify(params)
                });
                
                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    // If response is not JSON, treat as text
                    const text = await response.text();
                    data = { message: text };
                }
                
                const executionTime = ((Date.now() - startTime) / 1000).toFixed(2);
                
                if (response.ok) {
                    // Update status
                    toolStatus[toolName] = { status: 'success', lastExecuted: Date.now() };
                    if (statusDiv) {
                        statusDiv.innerHTML = `
                            <span class="tool-status-badge success">‚úì Executed</span>
                            <span>Last: ${new Date().toLocaleTimeString()}</span>
                        `;
                    }
                    
                    // Check if API returned an error (ok: false in response body)
                    if (data.ok === false) {
                        resultDiv.innerHTML = `
                            <div class="result error">
                                <h4>‚ùå Tool Error</h4>
                                <p style="margin: 8px 0; color: #721c24; font-weight: 600;">${data.error_code || 'ERROR'}</p>
                                <p style="margin: 8px 0; color: #721c24;">${data.message || 'Unknown error'}</p>
                                <pre style="margin-top: 10px; max-height: 400px; overflow-y: auto; background: #f8d7da; padding: 12px; border-radius: 4px; color: #721c24;">${JSON.stringify(data, null, 2)}</pre>
                                <div class="result-meta">
                                    ‚è±Ô∏è Execution time: ${executionTime}s | üìÖ ${new Date().toLocaleString()}
                                </div>
                            </div>
                        `;
                        toolStatus[toolName] = { status: 'error', lastExecuted: Date.now() };
                        if (statusDiv) {
                            statusDiv.innerHTML = `
                                <span class="tool-status-badge error">‚úó Error</span>
                                <span>Last: ${new Date().toLocaleTimeString()}</span>
                            `;
                        }
                        return;
                    }
                    
                    // Build a rich display of the response data
                    let dataDisplay = '';
                    
                    // Check if response has data array (like list_supported_doc_types)
                    if (data.data && Array.isArray(data.data)) {
                        dataDisplay = `
                            <div class="data-table-container" style="margin-top: 12px; background: #ffffff; border: 1px solid #dee2e6; border-radius: 6px; padding: 12px; max-height: 300px; overflow-y: auto;">
                                <div style="font-weight: 600; margin-bottom: 8px; color: #2c3e50;">üìä ${data.data.length} items returned:</div>
                                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                    <thead>
                                        <tr style="background: #f1f3f4;">
                                            ${Object.keys(data.data[0] || {}).map(k => `<th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6; color: #2c3e50; font-weight: 600;">${k}</th>`).join('')}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.data.map((item, idx) => `
                                            <tr style="border-bottom: 1px solid #e9ecef; background: ${idx % 2 === 0 ? '#fff' : '#f8f9fa'};">
                                                ${Object.values(item).map(v => `<td style="padding: 10px; color: #333;">${v}</td>`).join('')}
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                    
                    // Extract cost info if model was used (check multiple paths)
                    let costInfo = '';
                    let modelUsed = data.data?.model_used || data.model_used || null;
                    let costUsd = data.data?.cost_usd || data.cost_usd || null;
                    
                    // Check nested _metadata
                    if (data.data?._metadata?.modelUsed) {
                        modelUsed = data.data._metadata.modelUsed;
                    }
                    if (data.data?._metadata?.costUsd) {
                        costUsd = data.data._metadata.costUsd;
                    }
                    
                    // Build cost info display
                    if (modelUsed || costUsd) {
                        const displayModel = modelUsed || 'gemini-2.5-flash';
                        const displayCost = costUsd ? `$${Number(costUsd).toFixed(4)}` : '~$0.001';
                        costInfo = `<span style="background: #e3f2fd; color: #1565c0; padding: 4px 10px; border-radius: 4px; font-size: 12px; margin-left: 10px; font-weight: 500;">ü§ñ ${displayModel} | üí∞ ${displayCost}</span>`;
                    }
                    
                    // Always show the full JSON response - this is an inspector, we need to see everything
                    resultDiv.innerHTML = `
                        <div class="result success">
                            <h4>‚úÖ Success ${costInfo}</h4>
                            ${dataDisplay}
                            <div style="margin-top: 12px;">
                                <div style="font-weight: 600; margin-bottom: 8px; color: #2c3e50;">üìã Full Response:</div>
                                <pre style="max-height: 500px; overflow-y: auto; background: #f8f9fa; padding: 12px; border-radius: 4px; border: 1px solid #dee2e6; font-size: 12px; color: #212529;">${JSON.stringify(data, null, 2)}</pre>
                            </div>
                            <div class="result-meta">
                                ‚è±Ô∏è Execution time: ${executionTime}s | üìÖ ${new Date().toLocaleString()}
                            </div>
                        </div>
                    `;
                } else {
                    // Update status
                    toolStatus[toolName] = { status: 'error', lastExecuted: Date.now() };
                    if (statusDiv) {
                        statusDiv.innerHTML = `
                            <span class="tool-status-badge error">‚úó Error</span>
                            <span>Last: ${new Date().toLocaleTimeString()}</span>
                        `;
                    }
                    
                    resultDiv.innerHTML = `
                        <div class="result error">
                            <h4>‚ùå Execution Failed</h4>
                            <p style="margin: 8px 0; color: #721c24;">${data.error || data.message || 'Unknown error occurred'}</p>
                            <details style="margin-top: 10px;">
                                <summary style="cursor: pointer; color: #e74c3c; font-size: 13px; font-weight: 600;">üîç View error details</summary>
                                <pre style="margin-top: 10px; max-height: 400px; overflow-y: auto;">${JSON.stringify(data, null, 2)}</pre>
                            </details>
                            <div class="result-meta">
                                ‚è±Ô∏è Execution time: ${executionTime}s | üìÖ ${new Date().toLocaleString()}
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                // Update status
                toolStatus[toolName] = { status: 'error', lastExecuted: Date.now() };
                if (statusDiv) {
                    statusDiv.innerHTML = `
                        <span class="tool-status-badge error">‚úó Error</span>
                        <span>Last: ${new Date().toLocaleTimeString()}</span>
                    `;
                }
                
                const executionTime = ((Date.now() - startTime) / 1000).toFixed(2);
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h4>‚ùå Network Error</h4>
                        <p style="margin: 8px 0; color: #721c24;">${error.message}</p>
                        <p style="margin-top: 8px; font-size: 12px; color: #7f8c8d;">
                            Check that the server is running and the API key is correct.
                        </p>
                        <div class="result-meta">
                            ‚è±Ô∏è Execution time: ${executionTime}s | üìÖ ${new Date().toLocaleString()}
                        </div>
                    </div>
                `;
            } finally {
                executeBtn.disabled = false;
                executeBtn.textContent = '‚ñ∂ Execute Tool';
            }
        }
        
        // Toggle supported documents preview
        function toggleSupportedDocs() {
            const preview = document.getElementById('supportedDocsPreview');
            const toggle = document.getElementById('supportedDocsToggle');
            
            if (preview.style.display === 'none') {
                preview.style.display = 'block';
                toggle.textContent = '‚ñ≤ Hide';
                // Populate if empty
                if (!preview.innerHTML.trim()) {
                    preview.innerHTML = renderDocumentChecklist([]);  // Empty = show all as unchecked
                }
            } else {
                preview.style.display = 'none';
                toggle.textContent = '‚ñº Show';
            }
        }
        
        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            testConnection();
            // Restore current customer display
            if (currentCustomerId) {
                updateCurrentCustomerDisplay();
            }
            // Pre-populate supported docs preview
            const previewContainer = document.getElementById('supportedDocsPreview');
            if (previewContainer) {
                previewContainer.innerHTML = renderDocumentChecklist([]);
            }
        });
    </script>
</body>
</html>
