<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KYC Intel - MCP-Powered Trust Verification for US & Mexico Businesses</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh;
            color: #e2e8f0;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .logo {
            font-size: 42px;
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        
        .tagline {
            color: #94a3b8;
            font-size: 16px;
            font-weight: 400;
        }
        
        /* Server Status */
        .server-status {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        
        .server-status.connected {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        
        .server-status.disconnected {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }
        
        .status-dot.pulse {
            animation: pulse 1.5s infinite;
        }
        
        /* Progress Steps */
        .progress-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }
        
        .progress-bar::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 10%;
            right: 10%;
            height: 2px;
            background: #334155;
        }
        
        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
        }
        
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #334155;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        
        .step-circle.active {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }
        
        .step-circle.completed {
            background: #22c55e;
        }
        
        .step-label {
            font-size: 12px;
            color: #64748b;
            text-align: center;
        }
        
        .step-label.active {
            color: #e2e8f0;
        }
        
        /* Main Card */
        .main-card {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 32px;
            backdrop-filter: blur(10px);
        }
        
        .step-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .step-subtitle {
            color: #94a3b8;
            margin-bottom: 24px;
        }
        
        .live-badge {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            animation: pulse 2s infinite;
        }
        
        /* Client Selector */
        .client-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .client-card {
            background: #1e293b;
            border: 2px solid #334155;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        
        .client-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
        }
        
        .client-card.selected {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .client-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .client-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }
        
        .client-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .client-docs {
            font-size: 12px;
            color: #64748b;
        }
        
        /* Document List */
        .doc-list {
            background: #1e293b;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }
        
        .doc-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: rgba(51, 65, 85, 0.5);
        }
        
        .doc-item:last-child {
            margin-bottom: 0;
        }
        
        .doc-icon {
            font-size: 24px;
            margin-right: 12px;
        }
        
        .doc-info {
            flex: 1;
        }
        
        .doc-name {
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .doc-type {
            font-size: 12px;
            color: #64748b;
        }
        
        .doc-status {
            font-size: 20px;
        }
        
        /* Selectable checkbox for docs */
        .doc-select {
            width: 22px;
            height: 22px;
            border-radius: 6px;
            border: 2px solid #334155;
            background: #0f172a;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            color: transparent;
            transition: all 0.15s ease;
        }
        .doc-select:hover {
            border-color: #60a5fa;
        }
        .doc-select.checked {
            background: rgba(34, 197, 94, 0.15);
            border-color: #22c55e;
            color: #22c55e;
        }
        
        /* Extraction Progress */
        .extraction-item {
            background: #1e293b;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }
        
        .extraction-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .extraction-icon {
            font-size: 24px;
            margin-right: 12px;
        }
        
        .extraction-title {
            flex: 1;
            font-weight: 500;
        }
        
        .extraction-status {
            font-size: 14px;
            padding: 4px 12px;
            border-radius: 20px;
            background: #334155;
        }
        
        .extraction-status.done {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        
        .extraction-status.processing {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }
        
        .extraction-status.error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .progress-track {
            height: 6px;
            background: #334155;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .extraction-findings {
            background: rgba(51, 65, 85, 0.5);
            border-radius: 8px;
            padding: 12px;
            font-size: 13px;
        }
        
        .finding {
            display: flex;
            align-items: flex-start;
            margin-bottom: 6px;
        }
        
        .finding:last-child {
            margin-bottom: 0;
        }
        
        .finding-bullet {
            color: #22c55e;
            margin-right: 8px;
        }
        
        /* Validation Checklist */
        .validation-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            background: #1e293b;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .validation-icon {
            font-size: 20px;
            margin-right: 12px;
        }
        
        .validation-text {
            flex: 1;
        }
        
        .validation-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
        }
        
        .validation-status.pass {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        
        .validation-status.warn {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
        }
        
        .validation-status.fail {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        /* Score Ring */
        .score-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
            padding: 32px;
            background: #1e293b;
            border-radius: 16px;
            margin-bottom: 24px;
        }
        
        .score-ring {
            position: relative;
            width: 160px;
            height: 160px;
        }
        
        .score-ring svg {
            transform: rotate(-90deg);
        }
        
        .score-ring-bg {
            fill: none;
            stroke: #334155;
            stroke-width: 12;
        }
        
        .score-ring-fill {
            fill: none;
            stroke: url(#scoreGradient);
            stroke-width: 12;
            stroke-linecap: round;
            stroke-dasharray: 440;
            stroke-dashoffset: 440;
            transition: stroke-dashoffset 1.5s ease;
        }
        
        .score-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .score-number {
            font-size: 42px;
            font-weight: 700;
            background: linear-gradient(135deg, #22c55e, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .score-label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .score-details {
            text-align: left;
        }
        
        .score-detail-item {
            margin-bottom: 12px;
        }
        
        .score-detail-label {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 4px;
        }
        
        .score-detail-value {
            font-size: 18px;
            font-weight: 600;
        }
        
        /* Final Report Preview */
        .report-preview {
            background: linear-gradient(135deg, #1e3a5f, #2d4a6f);
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            margin-bottom: 24px;
        }
        
        .report-company {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .report-status {
            display: inline-block;
            padding: 8px 24px;
            border-radius: 24px;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 16px;
        }
        
        .report-status.approved {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid #22c55e;
        }
        
        .report-status.review {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
            border: 1px solid #eab308;
        }
        
        .report-status.rejected {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
        }
        
        .report-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
        }
        
        /* Buttons */
        .btn {
            padding: 14px 28px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
        }
        
        .btn-secondary {
            background: #334155;
            color: #e2e8f0;
        }
        
        .btn-secondary:hover {
            background: #475569;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Transparency Bar */
        .transparency-bar {
            display: flex;
            justify-content: center;
            gap: 32px;
            padding: 16px;
            background: rgba(51, 65, 85, 0.5);
            border-radius: 12px;
            margin-top: 24px;
        }
        
        .transparency-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .transparency-icon {
            font-size: 18px;
        }
        
        .transparency-value {
            font-weight: 600;
            color: #22c55e;
        }
        
        /* Error Message */
        .error-box {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            text-align: center;
        }
        
        .error-box h3 {
            color: #ef4444;
            margin-bottom: 8px;
        }
        
        .error-box p {
            color: #94a3b8;
            font-size: 14px;
        }
        
        .error-box code {
            background: #1e293b;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
        }
        
        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in {
            animation: slideIn 0.4s ease forwards;
        }
        
        /* Hidden */
        .hidden {
            display: none !important;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .client-selector {
                grid-template-columns: 1fr;
            }
            
            .score-container {
                flex-direction: column;
            }
            
            .transparency-bar {
                flex-direction: column;
                align-items: center;
                gap: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">KYC Intel</div>
            <div class="tagline">MCP-Powered Trust Verification for US & Mexico Businesses</div>
            <div class="server-status disconnected" id="serverStatus">
                <div class="status-dot"></div>
                <span id="statusText">Checking server...</span>
            </div>
        </div>
        
        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-step" data-step="1">
                <div class="step-circle active" id="step1-circle">1</div>
                <div class="step-label active">Discovery</div>
            </div>
            <div class="progress-step" data-step="2">
                <div class="step-circle" id="step2-circle">2</div>
                <div class="step-label">Extraction</div>
            </div>
            <div class="progress-step" data-step="3">
                <div class="step-circle" id="step3-circle">3</div>
                <div class="step-label">Profile</div>
            </div>
            <div class="progress-step" data-step="4">
                <div class="step-circle" id="step4-circle">4</div>
                <div class="step-label">Validation</div>
            </div>
            <div class="progress-step" data-step="5">
                <div class="step-circle" id="step5-circle">5</div>
                <div class="step-label">Report</div>
            </div>
        </div>
        
        <!-- Main Card -->
        <div class="main-card">
            
            <!-- Step 1: Discovery -->
            <div id="step1" class="step-content">
                <div class="step-title">
                    <span>üìÅ</span>
                    <span>Document Discovery</span>
                    <span class="live-badge">MCP</span>
                </div>
                <div class="step-subtitle">Select a client folder to begin KYC verification with MCP tool calling</div>
                
                <div id="serverError" class="error-box hidden">
                    <h3>‚ö†Ô∏è MCP Server Not Running</h3>
                    <p>Start the server with: <code>npm run dev</code></p>
                    <p style="margin-top: 8px;">The server should be running at <code>http://localhost:3000</code></p>
                </div>
                
                <div class="client-selector" id="clientSelector">
                    <!-- Will be populated from server -->
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        Loading clients from server...
                    </div>
                </div>
                
                <div id="docList" class="doc-list hidden">
                    <!-- Documents will be populated here -->
                </div>
                
                <div style="text-align: right;">
                    <button class="btn btn-primary" id="startBtn" disabled onclick="startExtraction()">
                        Begin MCP Extraction ‚Üí
                    </button>
                </div>
            </div>
            
            <!-- Step 2: Extraction -->
            <div id="step2" class="step-content hidden">
                <div class="step-title">
                    <span>ü§ñ</span>
                    <span>Extraction</span>
                    <span class="live-badge">LIVE</span>
                </div>
                <div class="step-subtitle">Gemini 2.5 is analyzing your documents in real-time</div>
                
                <div id="extractionList">
                    <!-- Extraction items will be populated here -->
                </div>
                
                <div class="transparency-bar">
                    <div class="transparency-item">
                        <span class="transparency-icon">‚è±Ô∏è</span>
                        <span>Elapsed:</span>
                        <span class="transparency-value" id="elapsedTime">0s</span>
                    </div>
                    <div class="transparency-item">
                        <span class="transparency-icon">üí∞</span>
                        <span>Est. Cost:</span>
                        <span class="transparency-value" id="currentCost">$0.00</span>
                    </div>
                    <div class="transparency-item">
                        <span class="transparency-icon">üìÑ</span>
                        <span>Processed:</span>
                        <span class="transparency-value" id="docsProcessed">0/0</span>
                    </div>
                </div>
                
                <!-- MCP Tool Call Log -->
                <div id="toolCallLog" style="margin-top: 20px; background: #0f172a; border-radius: 8px; padding: 12px; font-family: 'Monaco', 'Consolas', monospace; font-size: 11px; max-height: 200px; overflow-y: auto; border: 1px solid #334155;">
                    <div style="color: #64748b; margin-bottom: 8px; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">üîß MCP Tool Calls</div>
                    <div id="toolCallEntries"></div>
                </div>
            </div>
            
            <!-- Step 3: Profile Building -->
            <div id="step3" class="step-content hidden">
                <div class="step-title">
                    <span>üèóÔ∏è</span>
                    <span>Building Profile</span>
                </div>
                <div class="step-subtitle">Aggregating data from all sources</div>
                
                <div id="profileContent">
                    <!-- Profile visualization will be here -->
                </div>
            </div>
            
            <!-- Step 4: Validation -->
            <div id="step4" class="step-content hidden">
                <div class="step-title">
                    <span>‚öñÔ∏è</span>
                    <span>Compliance Validation</span>
                </div>
                <div class="step-subtitle">Checking against Mexican KYC requirements (LFPIORPI)</div>
                
                <div id="validationList">
                    <!-- Validation items will be populated here -->
                </div>
                
                <div class="score-container" id="scoreContainer" style="display: none;">
                    <div class="score-ring">
                        <svg width="160" height="160" viewBox="0 0 160 160">
                            <defs>
                                <linearGradient id="scoreGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" stop-color="#22c55e"/>
                                    <stop offset="100%" stop-color="#3b82f6"/>
                                </linearGradient>
                            </defs>
                            <circle class="score-ring-bg" cx="80" cy="80" r="70"/>
                            <circle class="score-ring-fill" id="scoreFill" cx="80" cy="80" r="70"/>
                        </svg>
                        <div class="score-value">
                            <div class="score-number" id="scoreNumber">0%</div>
                            <div class="score-label">Risk Score</div>
                        </div>
                    </div>
                    <div class="score-details">
                        <div class="score-detail-item">
                            <div class="score-detail-label">Decision</div>
                            <div class="score-detail-value" id="decision" style="color: #22c55e;">‚Äî</div>
                        </div>
                        <div class="score-detail-item">
                            <div class="score-detail-label">Risk Level</div>
                            <div class="score-detail-value" id="riskLevel">‚Äî</div>
                        </div>
                        <div class="score-detail-item">
                            <div class="score-detail-label">Flags</div>
                            <div class="score-detail-value" id="flagCount">‚Äî</div>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-primary" id="generateReportBtn" onclick="generateReport()">
                        Generate Report ‚Üí
                    </button>
                </div>
            </div>
            
            <!-- Step 5: Report -->
            <div id="step5" class="step-content hidden">
                <div class="step-title">
                    <span>üìÑ</span>
                    <span>KYC Report Generated</span>
                </div>
                <div class="step-subtitle">Your compliance report is ready</div>
                
                <div class="report-preview" id="reportPreview">
                    <div class="report-company" id="reportCompany">‚Äî</div>
                    <div class="report-status approved" id="reportStatus">‚úÖ APPROVED / APROBADO</div>
                    <div style="color: #94a3b8; font-size: 14px;">
                        KYC verification completed via MCP tool calling
                    </div>
                    <div class="report-actions">
                        <button class="btn btn-primary" onclick="viewReport()" style="min-width: 200px;">
                            üìÑ View Full Report
                        </button>
                    </div>
                </div>
                
                <div class="transparency-bar">
                    <div class="transparency-item">
                        <span class="transparency-icon">‚è±Ô∏è</span>
                        <span>Total Time:</span>
                        <span class="transparency-value" id="totalTime">‚Äî</span>
                    </div>
                    <div class="transparency-item">
                        <span class="transparency-icon">üí∞</span>
                        <span>Total Cost:</span>
                        <span class="transparency-value" id="totalCost">‚Äî</span>
                    </div>
                    <div class="transparency-item">
                        <span class="transparency-icon">üìÑ</span>
                        <span>Documents:</span>
                        <span class="transparency-value" id="totalDocs">‚Äî</span>
                    </div>
                    <div class="transparency-item">
                        <span class="transparency-icon">ü§ñ</span>
                        <span>AI Model:</span>
                        <span class="transparency-value">Gemini 2.5</span>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 24px;">
                    <button class="btn btn-secondary" onclick="resetWizard()">
                        ‚Üê Run Another KYC
                    </button>
                </div>
            </div>
            
        </div>
    </div>
    
    <script>
        // Configuration
        const MCP_SERVER = 'http://localhost:3000';
        
        // State
        let selectedClient = null;
        let currentFolderName = null;
        let clientDocs = [];
        let selectedDocs = [];
        let selectedDocPaths = new Set();
        let currentStep = 1;
        let startTime = null;
        let timerInterval = null;
        let reportUrl = null;
        let validationResult = null;
        let serverConnected = false;
        
        // Doc type icons
        const docIcons = {
            'acta': 'üè¢',
            'sat_constancia': 'üìã',
            'fm2': 'üõÇ',
            'ine': 'ü™™',
            'passport': 'üìò',
            'cfe': '‚ö°',
            'telmex': 'üìû',
            'bank_statement': 'üè¶',
            'bank_identity_page': 'üí≥',
            'other': 'üìÑ'
        };
        
        const docNames = {
            'acta': 'Corporate Charter / Acta Constitutiva',
            'sat_constancia': 'Tax Certificate / Constancia SAT',
            'fm2': 'Immigration / FM2',
            'ine': 'National ID / INE',
            'passport': 'Passport / Pasaporte',
            'cfe': 'Electric Bill / Recibo CFE',
            'telmex': 'Phone Bill / Recibo Telmex',
            'bank_statement': 'Bank Statement / Estado de Cuenta',
            'bank_identity_page': 'Bank Identity / P√°gina Identidad',
            'other': 'Other Document'
        };
        
        // Tool Call Logger - Shows MCP calls in real-time
        function logToolCall(tool, args, status = 'calling', result = null) {
            const entries = document.getElementById('toolCallEntries');
            if (!entries) return;
            
            const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
            const icons = { calling: 'üîÑ', success: '‚úÖ', error: '‚ùå' };
            const colors = { calling: '#fbbf24', success: '#22c55e', error: '#ef4444' };
            
            const shortArgs = typeof args === 'object' ? 
                Object.entries(args).map(([k,v]) => `${k}:${String(v).substring(0,20)}`).join(', ') : args;
            
            const resultText = result ? ` ‚Üí ${typeof result === 'string' ? result : JSON.stringify(result).substring(0,50)}` : '';
            
            const entry = document.createElement('div');
            entry.style.cssText = `color: ${colors[status]}; margin-bottom: 4px; line-height: 1.4;`;
            entry.innerHTML = `<span style="color:#64748b">[${timestamp}]</span> ${icons[status]} <span style="color:#60a5fa">${tool}</span>(${shortArgs})${resultText}`;
            
            entries.appendChild(entry);
            entries.parentElement.scrollTop = entries.parentElement.scrollHeight;
        }
        
        // Check server connection
        async function checkServer() {
            try {
                const response = await fetch(`${MCP_SERVER}/healthz`);
                if (response.ok) {
                    serverConnected = true;
                    document.getElementById('serverStatus').className = 'server-status connected';
                    document.getElementById('statusText').textContent = 'Server connected at localhost:3000';
                    document.querySelector('.status-dot').classList.add('pulse');
                    document.getElementById('serverError').classList.add('hidden');
                    loadClients();
                } else {
                    throw new Error('Server not healthy');
                }
            } catch (error) {
                serverConnected = false;
                document.getElementById('serverStatus').className = 'server-status disconnected';
                document.getElementById('statusText').textContent = 'Server disconnected';
                document.getElementById('serverError').classList.remove('hidden');
                document.getElementById('clientSelector').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        <p>Cannot connect to MCP server</p>
                        <p style="font-size: 12px; margin-top: 8px;">Run <code style="background: #334155; padding: 2px 6px; border-radius: 4px;">npm run dev</code> to start</p>
                    </div>
                `;
            }
        }
        
        // Load clients from server
        async function loadClients() {
            try {
                const response = await fetch(`${MCP_SERVER}/mcp/documents`);
                const data = await response.json();
                
                const clientSelector = document.getElementById('clientSelector');
                
                const customers = data.documents || data.customers || {};
                // Filter out empty folders and non-client folders
                const validCustomers = Object.entries(customers).filter(([name, docs]) => {
                    if (name === 'MCP-Improvements' || !docs || docs.length === 0) return false;
                    const validDocs = docs.filter(d => d.suggestedDocType !== 'skip' && d.suggestedDocType !== 'other');
                    return validDocs.length > 0;
                });
                
                if (validCustomers.length > 0) {
                    clientSelector.innerHTML = validCustomers.map(([name, docs]) => {
                        const docCount = docs.filter(d => d.suggestedDocType !== 'skip' && d.suggestedDocType !== 'other').length;
                        const isCorporate = docs.some(d => d.suggestedDocType === 'acta');
                        return `
                            <div class="client-card" onclick="selectClient('${name}', this)" data-client="${name}">
                                <div class="client-icon">${isCorporate ? 'üè¢' : 'üë§'}</div>
                                <div class="client-name">${name.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</div>
                                <div class="client-docs">${docCount} documents ‚Ä¢ ${isCorporate ? 'Corporate' : 'Individual'}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    clientSelector.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #64748b;">
                            No client folders found in ~/Desktop/mcp-docs/
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load clients:', error);
            }
        }
        
        // Select client
        // clientId is the folder name (e.g., "enrique-cello")
        // We create a UNIQUE customer ID per run to ensure only selected docs are used
        async function selectClient(clientId, element) {
            // Store folder name for later - actual customer ID created at extraction time
            currentFolderName = clientId;
            selectedClient = null; // Will be set when extraction starts
            
            // Update UI
            document.querySelectorAll('.client-card').forEach(card => {
                card.classList.remove('selected');
            });
            element.classList.add('selected');
            
            // Load documents for this client (use folder name)
            try {
                const response = await fetch(`${MCP_SERVER}/mcp/documents`);
                const data = await response.json();
                
                clientDocs = data.documents?.[currentFolderName] || data.customers?.[currentFolderName] || [];
                // Filter out skipped docs
                clientDocs = clientDocs.filter(d => d.suggestedDocType !== 'skip');
                // Default-select all docs (new docs come selected)
                selectedDocPaths = new Set(clientDocs.map(d => d.path));
                
                const docList = document.getElementById('docList');
                docList.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 12px; color: #94a3b8;">
                        Found ${clientDocs.length} documents in /${currentFolderName}/
                        <span id="docSelectionSummary" style="margin-left: 8px; color: #22c55e;">(${clientDocs.length} selected)</span>
                    </div>
                    ${clientDocs.map(doc => `
                        <div class="doc-item slide-in">
                            <div class="doc-icon">${docIcons[doc.suggestedDocType] || 'üìÑ'}</div>
                            <div class="doc-info">
                                <div class="doc-name">${doc.name}</div>
                                <div class="doc-type">${docNames[doc.suggestedDocType] || doc.suggestedDocType}</div>
                            </div>
                            <div class="doc-select ${selectedDocPaths.has(doc.path) ? 'checked' : ''}" 
                                 onclick="toggleDocSelection('${doc.path}', this)">${selectedDocPaths.has(doc.path) ? '‚úì' : ''}</div>
                        </div>
                    `).join('')}
                `;
                docList.classList.remove('hidden');
                
                // Enable button
                document.getElementById('startBtn').disabled = false;
            } catch (error) {
                console.error('Failed to load documents:', error);
            }
        }
        
        // Toggle selection of a single document
        function toggleDocSelection(path, el) {
            if (selectedDocPaths.has(path)) {
                selectedDocPaths.delete(path);
                el.classList.remove('checked');
                el.textContent = '';
            } else {
                selectedDocPaths.add(path);
                el.classList.add('checked');
                el.textContent = '‚úì';
            }
            updateDocSelectionSummary();
            updateStartButtonState();
        }
        
        function updateDocSelectionSummary() {
            const el = document.getElementById('docSelectionSummary');
            if (el) {
                el.textContent = `(${selectedDocPaths.size} selected)`;
            }
        }
        
        function updateStartButtonState() {
            const btn = document.getElementById('startBtn');
            btn.disabled = selectedDocPaths.size === 0;
        }
        
        // Start extraction
        async function startExtraction() {
            if (!serverConnected || !currentFolderName) return;
            
            // Create UNIQUE customer ID for this run (so only selected docs are used)
            const runTimestamp = Date.now();
            selectedClient = `${currentFolderName}-${runTimestamp}`;
            console.log(`Starting KYC run with unique customer ID: ${selectedClient}`);
            
            goToStep(2);
            startTime = Date.now();
            
            // Start timer
            timerInterval = setInterval(updateTimer, 100);
            
            const extractionList = document.getElementById('extractionList');
            extractionList.innerHTML = '';
            
            // Compute selected docs snapshot for this run
            selectedDocs = clientDocs.filter(d => selectedDocPaths.has(d.path));
            let processed = 0;
            const total = selectedDocs.length;
            let estimatedCost = 0;
            
            // Initialize counter to 0/total
            document.getElementById('docsProcessed').textContent = `0/${total}`;
            
            // Process each document with real API calls
            for (const doc of selectedDocs) {
                const itemId = `ext-${doc.name.replace(/[^a-z0-9]/gi, '')}`;
                
                // Add item to UI
                extractionList.innerHTML += `
                    <div class="extraction-item slide-in" id="${itemId}">
                        <div class="extraction-header">
                            <div class="extraction-icon">${docIcons[doc.suggestedDocType] || 'üìÑ'}</div>
                            <div class="extraction-title">${doc.name}</div>
                            <div class="extraction-status processing" id="${itemId}-status">‚è≥ Calling Gemini AI...</div>
                        </div>
                        <div class="progress-track">
                            <div class="progress-fill" id="${itemId}-progress" style="width: 20%"></div>
                        </div>
                        <div class="extraction-findings hidden" id="${itemId}-findings"></div>
                    </div>
                `;
                
                // Make real API call
                try {
                    document.getElementById(`${itemId}-progress`).style.width = '50%';
                    
                    // Log tool call start
                    logToolCall('import_kyc_document', { doc_type: doc.suggestedDocType, file: doc.name }, 'calling');
                    
                    const response = await fetch(`${MCP_SERVER}/mcp/tools/import_kyc_document`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            customer_id: selectedClient,
                            doc_type: doc.suggestedDocType,
                            file_url: doc.path
                        })
                    });
                    
                    const result = await response.json();
                    
                    document.getElementById(`${itemId}-progress`).style.width = '100%';
                    
                    if (result.success || result.data) {
                        // Log success
                        const extractedData = result.data || result;
                        const summary = extractedData.rfc || extractedData.razon_social || extractedData.full_name || 'Data extracted';
                        logToolCall('import_kyc_document', { file: doc.name }, 'success', summary);
                        
                        document.getElementById(`${itemId}-status`).textContent = '‚úÖ Extracted';
                        document.getElementById(`${itemId}-status`).classList.remove('processing');
                        document.getElementById(`${itemId}-status`).classList.add('done');
                        
                        // Show key findings
                        const findings = extractKeyFindings(result.data || result, doc.suggestedDocType);
                        if (findings.length > 0) {
                            document.getElementById(`${itemId}-findings`).innerHTML = findings.map(f => `
                                <div class="finding">
                                    <span class="finding-bullet">‚Üí</span>
                                    <span>${f}</span>
                                </div>
                            `).join('');
                            document.getElementById(`${itemId}-findings`).classList.remove('hidden');
                        }
                        
                        // Estimate cost based on doc type
                        estimatedCost += doc.suggestedDocType === 'acta' ? 0.15 : 0.05;
                    } else {
                        document.getElementById(`${itemId}-status`).textContent = '‚ö†Ô∏è Warning';
                        document.getElementById(`${itemId}-status`).classList.remove('processing');
                        document.getElementById(`${itemId}-status`).classList.add('error');
                    }
                } catch (error) {
                    console.error(`Error processing ${doc.name}:`, error);
                    logToolCall('import_kyc_document', { file: doc.name }, 'error', error.message || 'Failed');
                    document.getElementById(`${itemId}-status`).textContent = '‚ùå Error';
                    document.getElementById(`${itemId}-status`).classList.remove('processing');
                    document.getElementById(`${itemId}-status`).classList.add('error');
                }
                
                processed++;
                document.getElementById('docsProcessed').textContent = `${processed}/${total}`;
                document.getElementById('currentCost').textContent = `$${estimatedCost.toFixed(2)}`;
            }
            
            // Move to profile building
            setTimeout(() => buildProfile(), 1000);
        }
        
        // Extract key findings from API response
        function extractKeyFindings(data, docType) {
            const findings = [];
            
            if (!data) return findings;
            
            switch (docType) {
                case 'acta':
                    if (data.razon_social) findings.push(`Company: ${data.razon_social}`);
                    if (data.shareholders?.length) findings.push(`${data.shareholders.length} shareholders identified`);
                    if (data.legal_representatives?.length) findings.push(`${data.legal_representatives.length} legal representatives`);
                    break;
                case 'sat_constancia':
                    if (data.rfc) findings.push(`RFC: ${data.rfc}`);
                    if (data.estatus_padron) findings.push(`Status: ${data.estatus_padron}`);
                    if (data.tax_regime) findings.push(`Regime: ${data.tax_regime}`);
                    break;
                case 'passport':
                    if (data.full_name) findings.push(data.full_name);
                    if (data.nationality) findings.push(`Nationality: ${data.nationality}`);
                    if (data.expiry_date) findings.push(`Valid until: ${data.expiry_date}`);
                    break;
                case 'fm2':
                    if (data.document_type) findings.push(data.document_type);
                    if (data.immigration_status) findings.push(data.immigration_status);
                    break;
                case 'ine':
                    if (data.full_name) findings.push(data.full_name);
                    if (data.voter_id) findings.push(`Voter ID: ${data.voter_id}`);
                    break;
                case 'cfe':
                case 'telmex':
                    if (data.service_address) findings.push('Address verified');
                    if (data.bill_date) findings.push(`Bill date: ${data.bill_date}`);
                    break;
                case 'bank_identity_page':
                    if (data.account_holder_name) findings.push(`Holder: ${data.account_holder_name}`);
                    if (data.clabe) findings.push('CLABE verified');
                    break;
            }
            
            return findings;
        }
        
        // Update timer
        function updateTimer() {
            if (startTime) {
                const elapsed = (Date.now() - startTime) / 1000;
                document.getElementById('elapsedTime').textContent = `${elapsed.toFixed(1)}s`;
            }
        }
        
        // Build profile
        async function buildProfile() {
            goToStep(3);
            
            const profileContent = document.getElementById('profileContent');
            profileContent.innerHTML = `
                <div style="background: #1e293b; border-radius: 12px; padding: 24px; margin-bottom: 20px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 14px; color: #64748b; margin-bottom: 8px;">Building unified profile from ${selectedDocs.length} documents...</div>
                        <div class="progress-track" style="max-width: 400px; margin: 0 auto;">
                            <div class="progress-fill" id="profileProgress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            `;
            
            // Call real build_kyc_profile API
            try {
                document.getElementById('profileProgress').style.width = '50%';
                logToolCall('build_kyc_profile', { customer_id: selectedClient }, 'calling');
                
                const response = await fetch(`${MCP_SERVER}/mcp/tools/build_kyc_profile`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customer_id: selectedClient })
                });
                
                const result = await response.json();
                const companyName = result.data?.companyIdentity?.razon_social || result.data?.companyTaxProfile?.razon_social || selectedClient;
                logToolCall('build_kyc_profile', { customer_id: selectedClient }, 'success', companyName);
                
                document.getElementById('profileProgress').style.width = '100%';
                
                profileContent.innerHTML += `
                    <div style="text-align: center; margin-top: 20px;">
                        <div style="font-size: 32px; margin-bottom: 8px;">‚úÖ</div>
                        <div style="background: linear-gradient(135deg, #3b82f6, #8b5cf6); border-radius: 12px; padding: 16px; display: inline-block;">
                            <div style="font-weight: 600; font-size: 18px;">Profile Built Successfully</div>
                            <div style="font-size: 13px; opacity: 0.8;">${companyName}</div>
                        </div>
                    </div>
                `;
                
                setTimeout(() => runValidation(), 1500);
            } catch (error) {
                console.error('Failed to build profile:', error);
                logToolCall('build_kyc_profile', { customer_id: selectedClient }, 'error', error.message);
                profileContent.innerHTML += `<div style="color: #ef4444; text-align: center; margin-top: 20px;">Error building profile</div>`;
            }
        }
        
        // Run validation
        async function runValidation() {
            goToStep(4);
            
            const validationList = document.getElementById('validationList');
            validationList.innerHTML = `<div style="text-align: center; padding: 20px; color: #64748b;">Running compliance checks...</div>`;
            
            // Call real validate_kyc_profile API
            try {
                logToolCall('validate_kyc_profile', { customer_id: selectedClient }, 'calling');
                const response = await fetch(`${MCP_SERVER}/mcp/tools/validate_kyc_profile`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customer_id: selectedClient })
                });
                
                validationResult = await response.json();
                
                const flags = validationResult.data?.flags || [];
                const score = validationResult.data?.score || 0;
                const decision = validationResult.data?.decision || 'pending';
                logToolCall('validate_kyc_profile', { customer_id: selectedClient }, 'success', `${decision} (${score}%)`);
                logToolCall('get_kyc_report', { customer_id: selectedClient }, 'calling');
                
                // Display validation results
                validationList.innerHTML = '';
                
                // Show pass/fail for each check
                const checks = [
                    { text: 'Company/Individual Identity Verified', pass: true },
                    { text: 'Tax Registration (RFC) Validated', pass: true },
                    { text: 'Proof of Address Verified', pass: !flags.some(f => f.code?.includes('ADDRESS')) },
                    { text: 'Legal Representative Identified', pass: !flags.some(f => f.code?.includes('REP')) },
                ];
                
                // Add flags as warnings
                flags.forEach(flag => {
                    checks.push({
                        text: flag.message,
                        pass: flag.level === 'info',
                        warn: flag.level === 'warning',
                        fail: flag.level === 'critical'
                    });
                });
                
                checks.forEach((check, i) => {
                    setTimeout(() => {
                        validationList.innerHTML += `
                            <div class="validation-item slide-in">
                                <div class="validation-icon">${check.fail ? '‚ùå' : check.warn ? '‚ö†Ô∏è' : '‚úÖ'}</div>
                                <div class="validation-text">${check.text}</div>
                                <div class="validation-status ${check.fail ? 'fail' : check.warn ? 'warn' : 'pass'}">
                                    ${check.fail ? 'FAIL' : check.warn ? 'WARNING' : 'PASS'}
                                </div>
                            </div>
                        `;
                        
                        if (i === checks.length - 1) {
                            showScore(score, flags);
                        }
                    }, i * 300);
                });
                
            } catch (error) {
                console.error('Failed to validate:', error);
                logToolCall('validate_kyc_profile', { customer_id: selectedClient }, 'error', error.message);
                validationList.innerHTML = `<div style="color: #ef4444; text-align: center;">Error running validation</div>`;
            }
        }
        
        // Show score
        function showScore(score, flags) {
            document.getElementById('scoreContainer').style.display = 'flex';
            
            const scorePercent = Math.round(score * 100);
            const circumference = 440;
            const offset = circumference - (scorePercent / 100) * circumference;
            
            setTimeout(() => {
                document.getElementById('scoreFill').style.strokeDashoffset = offset;
                
                // Animate number
                let currentScore = 0;
                const scoreInterval = setInterval(() => {
                    currentScore += 2;
                    if (currentScore >= scorePercent) {
                        currentScore = scorePercent;
                        clearInterval(scoreInterval);
                    }
                    document.getElementById('scoreNumber').textContent = `${currentScore}%`;
                }, 30);
                
                const decision = scorePercent >= 90 ? 'APPROVED' : scorePercent >= 70 ? 'REVIEW' : 'REJECTED';
                document.getElementById('decision').textContent = decision;
                document.getElementById('decision').style.color = scorePercent >= 90 ? '#22c55e' : scorePercent >= 70 ? '#eab308' : '#ef4444';
                document.getElementById('riskLevel').textContent = scorePercent >= 90 ? 'LOW' : scorePercent >= 70 ? 'MEDIUM' : 'HIGH';
                document.getElementById('flagCount').textContent = `${flags.filter(f => f.level !== 'info').length} flags`;
            }, 300);
        }
        
        // Generate report
        async function generateReport() {
            clearInterval(timerInterval);
            
            // Call real get_kyc_report API
            try {
                const response = await fetch(`${MCP_SERVER}/mcp/tools/get_kyc_report`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customer_id: selectedClient, include_trace: true })
                });
                
                const result = await response.json();
                
                goToStep(5);
                
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                const scorePercent = Math.round((validationResult?.data?.score || 0) * 100);
                
                // Extract report URL from result
                reportUrl = result.data?.report_url || result.report_url;
                
                // Show friendly company name (from API or folder name, not the timestamped ID)
                const friendlyName = result.data?.company_name || 
                    currentFolderName.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                document.getElementById('reportCompany').textContent = friendlyName;
                
                const statusEl = document.getElementById('reportStatus');
                if (scorePercent >= 90) {
                    statusEl.textContent = '‚úÖ APPROVED / APROBADO';
                    statusEl.className = 'report-status approved';
                } else if (scorePercent >= 70) {
                    statusEl.textContent = '‚ö†Ô∏è REVIEW NEEDED / EN REVISI√ìN';
                    statusEl.className = 'report-status review';
                } else {
                    statusEl.textContent = '‚ùå REJECTED / RECHAZADO';
                    statusEl.className = 'report-status rejected';
                }
                
                document.getElementById('totalTime').textContent = `${elapsed}s`;
                document.getElementById('totalCost').textContent = `~$${(selectedDocs.length * 0.08).toFixed(2)} USD`;
                document.getElementById('totalDocs').textContent = `${selectedDocs.length} docs`;
                
            } catch (error) {
                console.error('Failed to generate report:', error);
            }
        }
        
        // View report
        async function viewReport() {
            // Try to get the latest report URL from server
            try {
                const response = await fetch(`${MCP_SERVER}/mcp/latest-report/${selectedClient}`);
                const data = await response.json();
                
                if (data.ok && data.report_url) {
                    // Open the report using the HTTP file server
                    window.open(`http://localhost:8888/${data.report_url}`, '_blank');
                    return;
                }
            } catch (error) {
                console.error('Error fetching latest report:', error);
            }
            
            // Fallback: try the report URL from the API response
            if (reportUrl) {
                const httpUrl = reportUrl.replace('file://', 'http://localhost:8888/');
                window.open(httpUrl, '_blank');
            } else {
                // Last fallback to reports folder
                window.open(`http://localhost:8888/data/${selectedClient}/reports/`, '_blank');
            }
        }
        
        // Export Excel
        function exportExcel() {
            if (reportUrl) {
                const excelUrl = reportUrl.replace('.html', '.xlsx').replace('file://', 'http://localhost:8888/');
                window.open(excelUrl, '_blank');
            }
        }
        
        // Go to step
        function goToStep(step) {
            currentStep = step;
            
            // Hide all steps
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
            
            // Show current step
            document.getElementById(`step${step}`).classList.remove('hidden');
            
            // Update progress circles
            for (let i = 1; i <= 5; i++) {
                const circle = document.getElementById(`step${i}-circle`);
                const label = circle.parentElement.querySelector('.step-label');
                
                circle.classList.remove('active', 'completed');
                label.classList.remove('active');
                
                if (i < step) {
                    circle.classList.add('completed');
                    circle.textContent = '‚úì';
                } else if (i === step) {
                    circle.classList.add('active');
                    label.classList.add('active');
                    circle.textContent = i;
                } else {
                    circle.textContent = i;
                }
            }
        }
        
        // Reset wizard
        function resetWizard() {
            selectedClient = null;
            currentFolderName = null;
            clientDocs = [];
            selectedDocs = [];
            selectedDocPaths = new Set();
            currentStep = 1;
            startTime = null;
            reportUrl = null;
            validationResult = null;
            
            document.querySelectorAll('.client-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('docList').classList.add('hidden');
            document.getElementById('startBtn').disabled = true;
            document.getElementById('scoreContainer').style.display = 'none';
            
            goToStep(1);
            loadClients();
        }
        
        // Initialize
        checkServer();
        setInterval(checkServer, 10000); // Check every 10 seconds
    </script>
</body>
</html>
